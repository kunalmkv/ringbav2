# Alternative Nginx Configuration for Ringba Dashboard Subdomain
# Use this if your vite.config.js has base: '/ringba-sync-dashboard/'
# This serves the dashboard at /ringba-sync-dashboard/ path (matching your existing pattern)
# Subdomain: ringba.insidefi.co

# Upstream for dashboard backend server
upstream dashboard_backend {
    server 127.0.0.1:3000;
}

server {
    listen 80;
    server_name ringba.insidefi.co;

    access_log /var/log/nginx/dashboard.access.log;
    error_log  /var/log/nginx/dashboard.error.log;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;

    # ============================================================================
    # Static Files - Serve at /ringba-sync-dashboard path
    # Uses 'alias' directive (matching your existing /ringba-sync-dashboard pattern)
    # Similar to your existing: location /ringba-sync-dashboard { alias /var/www/ringba-sync-dashboard; }
    # ============================================================================
    location /ringba-sync-dashboard {
        # Update this path to match your dashboard build directory
        alias /var/www/ringba/dashboard-build;
        index index.html;
        
        # SPA routing - serve index.html for all routes
        # Matching your existing try_files pattern
        try_files $uri $uri/ /ringba-sync-dashboard/index.html;
        
        # Cache static assets (JS, CSS, images, fonts)
        location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|map)$ {
            alias /var/www/ringba/dashboard-build;
            expires 7d;  # Matching your existing 7d cache
            add_header Cache-Control "public";  # Matching your existing config
            access_log off;
        }
        
        # Don't cache HTML files
        location ~* \.html$ {
            alias /var/www/ringba/dashboard-build;
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }
    }

    # ============================================================================
    # API routes - proxy to Node.js server
    # MUST be placed AFTER the static location block (matching your existing pattern)
    # ============================================================================
    location /ringba-sync-dashboard/api {
        # Strip the /ringba-sync-dashboard prefix and proxy to Node.js
        # Matching your existing rewrite pattern
        rewrite ^/ringba-sync-dashboard/api(/.*)$ /api$1 break;
        proxy_pass http://dashboard_backend;
        proxy_http_version 1.1;
        
        # WebSocket support
        proxy_set_header Upgrade           $http_upgrade;
        proxy_set_header Connection        "upgrade";
        
        # Standard proxy headers
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        
        # Set X-Forwarded-Proto to https (Cloudflare always uses HTTPS)
        proxy_set_header X-Forwarded-Proto https;
        
        # Cookie forwarding
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
        proxy_cookie_domain off;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Don't buffer responses
        proxy_buffering off;
        
        # CORS headers
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
        
        # Handle preflight requests
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain charset=UTF-8';
            add_header Content-Length 0;
            return 204;
        }
        
        # Disable caching for API responses
        add_header Cache-Control "no-store, no-cache, must-revalidate, private" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

